@inherits LayoutComponentBase
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<!-- Theme + providers -->
<MudThemeProvider Theme="@Themes.MinimalistTheme" @bind-IsDarkMode="_isDark" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

    <!-- DESKTOP: MdAndUp — mini left drawer, no app bar -->
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudDrawer Variant="DrawerVariant.Mini" Elevation="1" Anchor="Anchor.Left" @bind-Open="_leftOpenDesktop">
            <MudNavMenu Dense>
                @if (_leftOpenDesktop)
                {
                    <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All">Home</MudNavLink>

                    <MudNavGroup Title="Campaigns" Icon="@Icons.Material.Filled.CollectionsBookmark">
                        <MudNavLink Href="/campaign-hub" Icon="@Icons.Material.Filled.ViewModule">Campaign Hub</MudNavLink>
                        <MudNavLink Href="/campaign-hub/create" Icon="@Icons.Material.Filled.AddCircle">Create Campaign</MudNavLink>
                    </MudNavGroup>

                    <MudNavLink Href="/rules" Icon="@Icons.Material.Filled.MenuBook">Rules</MudNavLink>
                }
                else
                {
                    <MudTooltip Text="Home" Placement="Placement.Right">
                        <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All" />
                    </MudTooltip>

                    <MudNavGroup Title="Campaigns" Icon="@Icons.Material.Filled.CollectionsBookmark">
                        <MudTooltip Text="Campaign Hub" Placement="Placement.Right">
                            <MudNavLink Href="/campaign-hub" Icon="@Icons.Material.Filled.ViewModule">Campaign Hub</MudNavLink>
                        </MudTooltip>
                        <MudTooltip Text="Create Campaign" Placement="Placement.Right">
                            <MudNavLink Href="/campaign-hub/create" Icon="@Icons.Material.Filled.AddCircle">Create Campaign</MudNavLink>
                        </MudTooltip>
                    </MudNavGroup>

                    <MudTooltip Text="Rules" Placement="Placement.Right">
                        <MudNavLink Href="/rules" Icon="@Icons.Material.Filled.MenuBook" />
                    </MudTooltip>
                }
            </MudNavMenu>
            <MudSpacer />
            <MudNavMenu Dense>
                <MudNavLink Href="/settings">
                    <MudAvatar Size="Size.Medium" Variant="Variant.Outlined" Class="ml-n5">
                        <MudImage Src="images/landing/hero-1.png"></MudImage>
                    </MudAvatar>
                </MudNavLink>
                <MudStack Row="@_leftOpenDesktop" Class="ma-1" Spacing="0">
                    <MudIconButton Icon="@(_isDark? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" OnClick="@ToggleTheme" />
                    @if (_leftOpenDesktop)
                    {
                        <MudSpacer />
                    }
                    <MudIconButton Icon="@(_leftOpenDesktop? Icons.Material.Filled.KeyboardDoubleArrowLeft : Icons.Material.Filled.KeyboardDoubleArrowRight)" OnClick="@ToggleLeftDesktopDrawer" />
                </MudStack>
            </MudNavMenu>
        </MudDrawer>
    </MudHidden>

    <!-- MOBILE: SmAndDown — app bar with hamburger + temporary left drawer -->
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudAppBar Elevation="0">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" OnClick="@(() => _leftOpenMobile = true)" />
        </MudAppBar>

        <MudDrawer Anchor="Anchor.Left"
                   Variant="DrawerVariant.Temporary"
                   @bind-Open="@_leftOpenMobile"
                   Elevation="8">
            <MudNavMenu Dense>
                <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All">Home</MudNavLink>

                <MudNavGroup Title="Campaigns" Icon="@Icons.Material.Filled.CollectionsBookmark">
                    <MudNavLink Href="/campaign-hub" Icon="@Icons.Material.Filled.ViewModule">Campaign Hub</MudNavLink>
                    <MudNavLink Href="/campaign-hub/create" Icon="@Icons.Material.Filled.AddCircle">Create Campaign</MudNavLink>
                </MudNavGroup>

                <MudNavLink Href="/rules" Icon="@Icons.Material.Filled.MenuBook">Rules</MudNavLink>
            </MudNavMenu>
            <MudSpacer />
            <MudNavMenu Dense>
                <MudNavLink Href="/settings">
                    <MudAvatar Size="Size.Medium" Variant="Variant.Outlined" Class="ml-n5">
                        <MudImage Src="images/landing/hero-1.png"></MudImage>
                    </MudAvatar>
                </MudNavLink>
                <MudStack Row Class="ma-1" Spacing="0">
                    <MudIconButton Icon="@(_isDark? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" OnClick="@ToggleTheme" />
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => _leftOpenMobile = false)" />
                </MudStack>
            </MudNavMenu>
        </MudDrawer>
    </MudHidden>

    <!-- Right rail (unchanged) -->
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudDrawer Anchor="Anchor.Right" Variant="DrawerVariant.Persistent" Open="true" Class="ai-drawer">
            <ChatPanel />
        </MudDrawer>
    </MudHidden>

    <MudMainContent>
        @Body

        <!-- Mobile FAB + temporary bottom drawer (unchanged) -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudFab StartIcon="@Icons.Material.Filled.Chat"
                    Class="ai-fab"
                    Color="Color.Primary"
                    OnClick="@(() => _mobileOpen = true)" />

            <MudDrawer Anchor="Anchor.Bottom"
                       Variant="DrawerVariant.Temporary"
                       @bind-Open="_mobileOpen"
                       Class="@($"ai-drawer-mobile {(_mobileFullScreen ? "full" : "")}")"
                       Elevation="8">

                <MudPaper Class="chat-sheet d-flex flex-column" Style="height:100%;" Square>
                    <!-- Header row -->
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="chat-header">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIconButton Icon="@(_mobileFullScreen? Icons.Material.Filled.FullscreenExit : Icons.Material.Filled.Fullscreen)"
                                           AriaLabel="@(_mobileFullScreen ? "Exit full screen" : "Go full screen")"
                                           OnClick="@(()=> _mobileFullScreen = !_mobileFullScreen)" />
                            <MudText Typo="Typo.subtitle2">GM Chat</MudText>
                        </MudStack>

                        <!-- Always show the X -->
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       AriaLabel="Close chat"
                                       OnClick="@(()=> { _mobileOpen = false; _mobileFullScreen = false; })" />
                    </MudStack>

                    <!-- Content -->
                    <div style="flex:1; min-height:0;">
                        <ChatPanel />
                    </div>
                </MudPaper>
            </MudDrawer>
        </MudHidden>
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDark;
    private bool _mobileOpen;
    private bool _leftOpenMobile;
    private bool _leftOpenDesktop;
    private bool _mobileFullScreen = false;

    private void ToggleLeftDesktopDrawer()
    {
        _leftOpenDesktop = !_leftOpenDesktop;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isDark = await JS.InvokeAsync<bool>("themeStorage.init");
            StateHasChanged();
        }
    }

    private async Task ToggleTheme()
    {
        _isDark = !_isDark;
        await JS.InvokeVoidAsync("themeStorage.set", _isDark);
    }
}
